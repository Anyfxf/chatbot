<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KivestAI Chat</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a28;
            --bg-hover: #222236;
            --accent: #6c63ff;
            --accent-glow: rgba(108, 99, 255, 0.3);
            --accent-light: #8b83ff;
            --text-primary: #eaeaef;
            --text-secondary: #8888a0;
            --text-muted: #55556a;
            --border: #2a2a3d;
            --border-light: #33334a;
            --user-bg: linear-gradient(135deg, #6c63ff, #5a4fff);
            --bot-bg: #16162a;
            --danger: #ff4757;
            --success: #2ed573;
            --warning: #ffa502;
            --agent-researcher: #4ecdc4;
            --agent-critic: #ff6b6b;
            --agent-manager: #a29bfe;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100dvh;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        #sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 100;
        }

        #sidebar.hidden {
            transform: translateX(-100%);
            position: absolute;
            height: 100%;
        }

        .sidebar-header {
            padding: 20px 16px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-header h2 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        #new-chat-btn {
            width: 100%;
            padding: 10px 16px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            transition: all 0.2s;
        }

        #new-chat-btn:hover {
            background: var(--accent-light);
            box-shadow: 0 0 20px var(--accent-glow);
        }

        #chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .chat-item {
            padding: 12px 14px;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.15s;
            border: 1px solid transparent;
        }

        .chat-item:hover {
            background: var(--bg-hover);
        }

        .chat-item.active {
            background: var(--bg-tertiary);
            border-color: var(--border-light);
        }

        .chat-item-title {
            font-size: 13px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .chat-item-meta {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .chat-item-delete {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            font-size: 14px;
            opacity: 0;
            transition: all 0.15s;
        }

        .chat-item:hover .chat-item-delete {
            opacity: 1;
        }

        .chat-item-delete:hover {
            color: var(--danger);
            background: rgba(255, 71, 87, 0.1);
        }

        .sidebar-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
        }

        #clear-all-btn {
            width: 100%;
            padding: 8px;
            background: none;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        #clear-all-btn:hover {
            border-color: var(--danger);
            color: var(--danger);
        }

        /* Main Area */
        #main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        /* Top Bar */
        #topbar {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            gap: 10px;
            flex-wrap: wrap;
        }

        #menu-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            padding: 6px;
            border-radius: 8px;
            display: none;
        }

        #menu-btn:hover {
            background: var(--bg-hover);
        }

        .model-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .model-selector select {
            padding: 8px 12px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 13px;
            font-family: 'Inter', sans-serif;
            outline: none;
            cursor: pointer;
            max-width: 200px;
        }

        .model-selector select:focus {
            border-color: var(--accent);
        }

        .model-badge {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-premium {
            background: rgba(108, 99, 255, 0.15);
            color: var(--accent-light);
        }

        .badge-standard {
            background: rgba(46, 213, 115, 0.15);
            color: var(--success);
        }

        .topbar-toggles {
            display: flex;
            gap: 6px;
        }

        .toggle-btn {
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
            white-space: nowrap;
        }

        .toggle-btn.active {
            background: rgba(108, 99, 255, 0.15);
            border-color: var(--accent);
            color: var(--accent-light);
        }

        .toggle-btn.active-deep {
            background: rgba(255, 107, 107, 0.15);
            border-color: var(--agent-critic);
            color: var(--agent-critic);
        }

        .toggle-btn:hover {
            border-color: var(--accent);
        }

        #settings-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 7px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }

        #settings-btn:hover {
            border-color: var(--accent);
            color: var(--accent-light);
        }

        /* Chat Area */
        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            scroll-behavior: smooth;
        }

        #chat-container::-webkit-scrollbar {
            width: 6px;
        }

        #chat-container::-webkit-scrollbar-track {
            background: transparent;
        }

        #chat-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .message {
            max-width: 80%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-wrapper {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .message-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding-left: 4px;
        }

        .user-label { color: var(--accent-light); }
        .bot-label { color: var(--text-secondary); }

        .message-bubble {
            padding: 14px 18px;
            border-radius: 16px;
            line-height: 1.65;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .user-msg {
            align-self: flex-end;
        }

        .user-msg .message-bubble {
            background: var(--user-bg);
            color: white;
            border-bottom-right-radius: 6px;
        }

        .bot-msg {
            align-self: flex-start;
        }

        .bot-msg .message-bubble {
            background: var(--bot-bg);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-bottom-left-radius: 6px;
        }

        .thinking-block {
            background: rgba(255, 165, 2, 0.05);
            border: 1px solid rgba(255, 165, 2, 0.2);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 8px;
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .thinking-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--warning);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .thinking-content {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .thinking-content.collapsed {
            max-height: 60px;
            overflow: hidden;
            mask-image: linear-gradient(to bottom, black 30px, transparent);
            -webkit-mask-image: linear-gradient(to bottom, black 30px, transparent);
        }

        .model-tag {
            font-size: 10px;
            color: var(--text-muted);
            padding-left: 4px;
            margin-top: 2px;
        }

        /* Streaming cursor */
        .streaming-cursor::after {
            content: '‚ñã';
            animation: blink 1s infinite;
            color: var(--accent);
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        /* Typing indicator */
        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 8px 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            color: var(--text-muted);
            text-align: center;
            padding: 40px;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: 13px;
            max-width: 300px;
            line-height: 1.5;
        }

        /* Input Area */
        #input-area {
            padding: 12px 16px 16px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
        }

        .input-wrapper {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 8px 8px 8px 16px;
            transition: border-color 0.2s;
        }

        .input-wrapper:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        #message-input {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            outline: none;
            resize: none;
            max-height: 120px;
            min-height: 24px;
            line-height: 1.5;
        }

        #message-input::placeholder {
            color: var(--text-muted);
        }

        #send-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: none;
            background: var(--accent);
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        #send-btn:hover {
            background: var(--accent-light);
            box-shadow: 0 0 20px var(--accent-glow);
        }

        #send-btn:disabled {
            background: var(--bg-hover);
            color: var(--text-muted);
            cursor: not-allowed;
            box-shadow: none;
        }

        .input-info {
            display: flex;
            justify-content: space-between;
            padding: 6px 4px 0;
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Settings Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            width: 100%;
            max-width: 480px;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.3s;
        }

        .modal-overlay.visible .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 16px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
        }

        .modal-body {
            padding: 20px 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            border-color: var(--accent);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group .hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .save-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
        }

        .save-btn:hover {
            background: var(--accent-light);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            padding: 10px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 13px;
            color: var(--text-primary);
            z-index: 300;
            opacity: 0;
            transition: all 0.3s;
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Deep Think Panel */
        .deep-think-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            margin-bottom: 8px;
            overflow: hidden;
            animation: fadeIn 0.3s ease;
        }

        .deep-think-header {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }

        .deep-think-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .deep-think-status {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .deep-think-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .deep-think-progress {
            height: 3px;
            background: var(--bg-tertiary);
        }

        .deep-think-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--agent-researcher), var(--agent-critic), var(--agent-manager));
            transition: width 0.5s ease;
            border-radius: 3px;
        }

        .deep-think-body {
            padding: 0 16px 16px;
            max-height: 400px;
            overflow-y: auto;
        }

        .deep-think-body.collapsed {
            max-height: 0;
            padding: 0 16px;
            overflow: hidden;
        }

        .agent-message {
            padding: 10px 14px;
            border-radius: 10px;
            margin-bottom: 8px;
            font-size: 12px;
            line-height: 1.55;
            animation: agentFadeIn 0.4s ease;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        @keyframes agentFadeIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .agent-researcher {
            background: rgba(78, 205, 196, 0.08);
            border-left: 3px solid var(--agent-researcher);
        }

        .agent-critic {
            background: rgba(255, 107, 107, 0.08);
            border-left: 3px solid var(--agent-critic);
        }

        .agent-manager {
            background: rgba(162, 155, 254, 0.08);
            border-left: 3px solid var(--agent-manager);
        }

        .agent-tag {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .agent-tag-researcher { color: var(--agent-researcher); }
        .agent-tag-critic { color: var(--agent-critic); }
        .agent-tag-manager { color: var(--agent-manager); }

        .agent-text {
            color: var(--text-secondary);
        }

        .deep-think-toggle-arrow {
            font-size: 12px;
            color: var(--text-muted);
            transition: transform 0.2s;
        }

        .deep-think-toggle-arrow.open {
            transform: rotate(180deg);
        }

        .deep-think-done-check {
            color: var(--success);
            font-size: 14px;
        }

        /* Mobile */
        @media (max-width: 768px) {
            #sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100%;
                transform: translateX(-100%);
                z-index: 150;
                box-shadow: 4px 0 24px rgba(0, 0, 0, 0.5);
            }

            #sidebar.show {
                transform: translateX(0);
            }

            #menu-btn {
                display: block;
            }

            .message {
                max-width: 90%;
            }

            .model-badge {
                display: none;
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 140;
            }

            .sidebar-overlay.show {
                display: block;
            }
        }

        /* Code blocks */
        code {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 13px;
            font-family: 'Courier New', monospace;
        }

        pre {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px;
            overflow-x: auto;
            margin: 8px 0;
            font-size: 13px;
            line-height: 1.5;
        }

        pre code {
            background: none;
            padding: 0;
        }
    </style>
</head>
<body>

    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Sidebar -->
    <aside id="sidebar">
        <div class="sidebar-header">
            <h2>üí¨ Chats</h2>
            <button id="new-chat-btn">‚ú® New Chat</button>
        </div>
        <div id="chat-list"></div>
        <div class="sidebar-footer">
            <button id="clear-all-btn">üóë Clear All Chats</button>
        </div>
    </aside>

    <!-- Main -->
    <main id="main">
        <div id="topbar">
            <button id="menu-btn">‚ò∞</button>

            <div class="model-selector">
                <select id="model-select">
                    <optgroup label="üü£ Premium">
                        <option value="qwen3-coder-plus">Qwen3 Coder Plus</option>
                        <option value="qwen3.5-plus">Qwen3.5 Plus</option>
                        <option value="qwen3.5-397b-a17b">Qwen3.5 397B</option>
                        <option value="qwen3-max-2026-01-23">Qwen3 Max</option>
                        <option value="glm-5">GLM-5</option>
                        <option value="claude-opus-4.5">Opus 4.5</option>
                    </optgroup>
                    <optgroup label="üü¢ Standard">
                        <option value="kimi">Kimi</option>
                        <option value="glm-4.7">GLM-4.7</option>
                        <option value="qwen3-vl-plus">Qwen3 VL Plus</option>
                        <option value="qwen-plus-2025-07-28">Qwen Plus</option>
                    </optgroup>
                </select>
                <span class="model-badge badge-premium" id="model-badge">PREMIUM</span>
            </div>

            <div class="topbar-toggles">
                <button class="toggle-btn" id="thinking-toggle">üí≠ Think</button>
                <button class="toggle-btn" id="deep-think-toggle">üß† Deep Think</button>
                <button class="toggle-btn" id="stream-toggle" data-active="true">‚ö° Stream</button>
            </div>

            <button id="settings-btn">‚öôÔ∏è</button>
        </div>

        <div id="chat-container">
            <div class="empty-state">
                <div class="empty-state-icon">‚ö°</div>
                <h3>KivestAI Chat</h3>
                <p>Free AI chat powered by Qwen, GLM & Kimi models. Set your API key in ‚öôÔ∏è settings to start.</p>
            </div>
        </div>

        <div id="input-area">
            <div class="input-wrapper">
                <textarea id="message-input" placeholder="Send a message..." rows="1"></textarea>
                <button id="send-btn">‚Üë</button>
            </div>
            <div class="input-info">
                <span id="status-text">Ready</span>
                <span id="token-count"></span>
            </div>
        </div>
    </main>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>‚öôÔ∏è Settings</h2>
                <button class="modal-close" id="modal-close">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>API Key</label>
                    <input type="password" id="api-key-input" placeholder="Paste your API key from Discord...">
                    <p class="hint">Your key is stored locally on your device only.</p>
                </div>
                <div class="form-group">
                    <label>System Prompt</label>
                    <textarea id="system-prompt-input" placeholder="You are a helpful assistant...">You are a helpful assistant.</textarea>
                    <p class="hint">Custom instructions the AI will follow. Applied to new chats.</p>
                </div>
                <div class="form-group">
                    <label>API Endpoint</label>
                    <input type="text" id="endpoint-input" value="https://ai.ezif.in/v1">
                    <p class="hint">Default: https://ai.ezif.in/v1</p>
                </div>
                <button class="save-btn" id="save-settings-btn">üíæ Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ===== State =====
        let state = {
            apiKey: localStorage.getItem("kiv_api_key") || "",
            endpoint: localStorage.getItem("kiv_endpoint") || "https://ai.ezif.in/v1",
            systemPrompt: localStorage.getItem("kiv_system_prompt") || "You are a helpful assistant.",
            streaming: true,
            thinking: false,
            deepThink: false,
            chats: JSON.parse(localStorage.getItem("kiv_chats") || "[]"),
            activeChatId: null,
            isGenerating: false,
            abortController: null
        };

        // ===== Elements =====
        const $ = id => document.getElementById(id);
        const chatContainer = $("chat-container");
        const messageInput = $("message-input");
        const sendBtn = $("send-btn");
        const modelSelect = $("model-select");
        const modelBadge = $("model-badge");
        const thinkingToggle = $("thinking-toggle");
        const deepThinkToggle = $("deep-think-toggle");
        const streamToggle = $("stream-toggle");
        const settingsBtn = $("settings-btn");
        const settingsModal = $("settings-modal");
        const modalClose = $("modal-close");
        const apiKeyInput = $("api-key-input");
        const systemPromptInput = $("system-prompt-input");
        const endpointInput = $("endpoint-input");
        const saveSettingsBtn = $("save-settings-btn");
        const chatList = $("chat-list");
        const newChatBtn = $("new-chat-btn");
        const clearAllBtn = $("clear-all-btn");
        const menuBtn = $("menu-btn");
        const sidebar = $("sidebar");
        const sidebarOverlay = $("sidebar-overlay");
        const statusText = $("status-text");
        const tokenCount = $("token-count");
        const toast = $("toast");

        // ===== Model Info =====
        const modelInfo = {
            "qwen3-coder-plus": { name: "Qwen3 Coder Plus", tier: "premium", provider: "Qwen" },
            "qwen3.5-plus": { name: "Qwen3.5 Plus", tier: "premium", provider: "Qwen" },
            "qwen3.5-397b-a17b": { name: "Qwen3.5 397B", tier: "premium", provider: "Qwen" },
            "qwen3-max-2026-01-23": { name: "Qwen3 Max", tier: "premium", provider: "Qwen" },
            "glm-5": { name: "GLM-5", tier: "premium", provider: "Zhipu" },
            "kimi": { name: "Kimi", tier: "standard", provider: "Moonshot" },
            "glm-4.7": { name: "GLM-4.7", tier: "standard", provider: "Zhipu" },
            "qwen3-vl-plus": { name: "Qwen3 VL Plus", tier: "standard", provider: "Qwen" },
            "qwen-plus-2025-07-28": { name: "Qwen Plus", tier: "standard", provider: "Qwen" },
            "claude-opus-4.5": { name: "Opus 4.5", tier: "premium", provider: "Anthropic" }
        };

        // ===== Toast =====
        function showToast(msg) {
            toast.textContent = msg;
            toast.classList.add("show");
            setTimeout(() => toast.classList.remove("show"), 2500);
        }

        // ===== Model Badge =====
        function updateModelBadge() {
            const info = modelInfo[modelSelect.value];
            if (info) {
                modelBadge.textContent = info.tier.toUpperCase();
                modelBadge.className = `model-badge badge-${info.tier}`;
            }
        }

        modelSelect.addEventListener("change", updateModelBadge);
        updateModelBadge();

        // ===== Toggles =====
        streamToggle.classList.add("active");

        thinkingToggle.addEventListener("click", () => {
            state.thinking = !state.thinking;
            thinkingToggle.classList.toggle("active", state.thinking);
            if (state.thinking && state.deepThink) {
                state.deepThink = false;
                deepThinkToggle.classList.remove("active-deep");
            }
        });

        deepThinkToggle.addEventListener("click", () => {
            state.deepThink = !state.deepThink;
            deepThinkToggle.classList.toggle("active-deep", state.deepThink);
            if (state.deepThink && state.thinking) {
                state.thinking = false;
                thinkingToggle.classList.remove("active");
            }
        });

        streamToggle.addEventListener("click", () => {
            state.streaming = !state.streaming;
            streamToggle.classList.toggle("active", state.streaming);
        });

        // ===== Settings Modal =====
        settingsBtn.addEventListener("click", () => {
            apiKeyInput.value = state.apiKey;
            systemPromptInput.value = state.systemPrompt;
            endpointInput.value = state.endpoint;
            settingsModal.classList.add("visible");
        });

        function closeModal() {
            settingsModal.classList.remove("visible");
        }

        modalClose.addEventListener("click", closeModal);
        settingsModal.addEventListener("click", (e) => {
            if (e.target === settingsModal) closeModal();
        });

        saveSettingsBtn.addEventListener("click", () => {
            state.apiKey = apiKeyInput.value.trim();
            state.systemPrompt = systemPromptInput.value.trim() || "You are a helpful assistant.";
            state.endpoint = endpointInput.value.trim() || "https://ai.ezif.in/v1";

            localStorage.setItem("kiv_api_key", state.apiKey);
            localStorage.setItem("kiv_system_prompt", state.systemPrompt);
            localStorage.setItem("kiv_endpoint", state.endpoint);

            closeModal();
            showToast("‚úÖ Settings saved!");
        });

        // ===== Sidebar =====
        menuBtn.addEventListener("click", () => {
            sidebar.classList.toggle("show");
            sidebarOverlay.classList.toggle("show");
        });

        sidebarOverlay.addEventListener("click", () => {
            sidebar.classList.remove("show");
            sidebarOverlay.classList.remove("show");
        });

        // ===== Chat Management =====
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
        }

        function saveChats() {
            localStorage.setItem("kiv_chats", JSON.stringify(state.chats));
        }

        function getActiveChat() {
            return state.chats.find(c => c.id === state.activeChatId);
        }

        function createNewChat() {
            const chat = {
                id: generateId(),
                title: "New Chat",
                model: modelSelect.value,
                messages: [
                    { role: "system", content: state.systemPrompt }
                ],
                created: Date.now()
            };
            state.chats.unshift(chat);
            state.activeChatId = chat.id;
            saveChats();
            renderChatList();
            renderMessages();
            return chat;
        }

        newChatBtn.addEventListener("click", () => {
            createNewChat();
            sidebar.classList.remove("show");
            sidebarOverlay.classList.remove("show");
            messageInput.focus();
        });

        clearAllBtn.addEventListener("click", () => {
            if (confirm("Delete all chats? This cannot be undone.")) {
                state.chats = [];
                state.activeChatId = null;
                saveChats();
                renderChatList();
                renderMessages();
                showToast("üóë All chats cleared");
            }
        });

        function renderChatList() {
            chatList.innerHTML = "";
            state.chats.forEach(chat => {
                const div = document.createElement("div");
                div.className = `chat-item ${chat.id === state.activeChatId ? "active" : ""}`;
                div.innerHTML = `
                    <div style="min-width:0;flex:1">
                        <div class="chat-item-title">${escapeHtml(chat.title)}</div>
                        <div class="chat-item-meta">${modelInfo[chat.model]?.name || chat.model}</div>
                    </div>
                    <button class="chat-item-delete" data-id="${chat.id}">‚úï</button>
                `;
                div.addEventListener("click", (e) => {
                    if (e.target.classList.contains("chat-item-delete")) {
                        e.stopPropagation();
                        deleteChat(e.target.dataset.id);
                        return;
                    }
                    state.activeChatId = chat.id;
                    modelSelect.value = chat.model;
                    updateModelBadge();
                    renderChatList();
                    renderMessages();
                    sidebar.classList.remove("show");
                    sidebarOverlay.classList.remove("show");
                });
                chatList.appendChild(div);
            });
        }

        function deleteChat(id) {
            state.chats = state.chats.filter(c => c.id !== id);
            if (state.activeChatId === id) {
                state.activeChatId = state.chats[0]?.id || null;
            }
            saveChats();
            renderChatList();
            renderMessages();
        }

        function updateChatTitle(chat) {
            const firstUserMsg = chat.messages.find(m => m.role === "user");
            if (firstUserMsg) {
                chat.title = firstUserMsg.content.slice(0, 40) + (firstUserMsg.content.length > 40 ? "..." : "");
            }
        }

        // ===== Rendering =====
        function escapeHtml(text) {
            const div = document.createElement("div");
            div.textContent = text;
            return div.innerHTML;
        }

        function formatContent(text) {
            let formatted = escapeHtml(text);
            formatted = formatted.replace(/```(\w*)\n?([\s\S]*?)```/g, (_, lang, code) => {
                return `<pre><code>${code.trim()}</code></pre>`;
            });
            formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');
            formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            return formatted;
        }

        function renderMessages() {
            const chat = getActiveChat();

            if (!chat) {
                chatContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö°</div>
                        <h3>KivestAI Chat</h3>
                        <p>Free AI chat powered by Qwen, GLM & Kimi models. Set your API key in ‚öôÔ∏è settings, then start a new chat.</p>
                    </div>
                `;
                return;
            }

            chatContainer.innerHTML = "";

            chat.messages.forEach(msg => {
                if (msg.role === "system") return;

                const wrapper = document.createElement("div");
                wrapper.className = `message ${msg.role === "user" ? "user-msg" : "bot-msg"}`;

                let html = '<div class="message-wrapper">';
                html += `<span class="message-label ${msg.role === "user" ? "user-label" : "bot-label"}">${msg.role === "user" ? "You" : modelInfo[chat.model]?.name || chat.model}</span>`;

                // Deep Think block
                if (msg.deepThinkLog && msg.deepThinkLog.length > 0) {
                    html += `<div class="deep-think-panel">`;
                    html += `<div class="deep-think-header" onclick="this.nextElementSibling.nextElementSibling.classList.toggle('collapsed'); this.querySelector('.deep-think-toggle-arrow').classList.toggle('open')">`;
                    html += `<div class="deep-think-header-left">`;
                    html += `<span class="deep-think-done-check">‚úì</span>`;
                    html += `<span class="deep-think-status">Deep Think Complete ‚Äî ${msg.deepThinkLog.length} steps</span>`;
                    html += `</div>`;
                    html += `<span class="deep-think-toggle-arrow">‚ñº</span>`;
                    html += `</div>`;
                    html += `<div class="deep-think-progress"><div class="deep-think-progress-bar" style="width:100%"></div></div>`;
                    html += `<div class="deep-think-body collapsed">`;
                    msg.deepThinkLog.forEach(entry => {
                        html += `<div class="agent-message agent-${entry.agent}">`;
                        html += `<div class="agent-tag agent-tag-${entry.agent}">${entry.icon} ${entry.label}</div>`;
                        html += `<div class="agent-text">${escapeHtml(entry.text)}</div>`;
                        html += `</div>`;
                    });
                    html += `</div></div>`;
                }

                // Thinking block
                if (msg.reasoning_content) {
                    html += `
                        <div class="thinking-block">
                            <div class="thinking-label" onclick="this.nextElementSibling.classList.toggle('collapsed')">
                                üí≠ Reasoning (click to toggle)
                            </div>
                            <div class="thinking-content collapsed">${escapeHtml(msg.reasoning_content)}</div>
                        </div>
                    `;
                }

                html += `<div class="message-bubble">${formatContent(msg.content)}</div>`;
                html += '</div>';

                wrapper.innerHTML = html;
                chatContainer.appendChild(wrapper);
            });

            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // ===== Auto-resize textarea =====
        messageInput.addEventListener("input", () => {
            messageInput.style.height = "auto";
            messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + "px";
        });

        // ============================================================
        // ===== DEEP THINK: Multi-Agent Pipeline =====
        // ============================================================
        // 
        // Uses 3 "agent instances" (Researcher, Critic, Manager) that are
        // actually separate API calls with different system prompts, all
        // using the same model. We reuse instances by keeping track and
        // limiting to at most 4 API calls total (researcher, critic,
        // researcher-revision, manager) with delays to stay under rate limits.
        //
        // Rate limit: 30 msgs/min, 5 burst. We send max 4 calls with
        // 1.5s delays between them ‚Üí safe.
        // ============================================================

        async function callAgent(systemPrompt, messages, model, signal) {
            const body = {
                model: model,
                messages: [
                    { role: "system", content: systemPrompt },
                    ...messages
                ],
                stream: false
            };

            const response = await fetch(`${state.endpoint}/chat/completions`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${state.apiKey}`
                },
                body: JSON.stringify(body),
                signal: signal
            });

            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(err.error?.message || err.error || `HTTP ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function createDeepThinkUI() {
            const panel = document.createElement("div");
            panel.className = "message bot-msg";
            panel.style.maxWidth = "90%";
            panel.innerHTML = `
                <div class="message-wrapper">
                    <span class="message-label bot-label">üß† DEEP THINK</span>
                    <div class="deep-think-panel" id="live-deep-think">
                        <div class="deep-think-header">
                            <div class="deep-think-header-left">
                                <div class="deep-think-spinner"></div>
                                <span class="deep-think-status" id="dt-status">Initializing agents...</span>
                            </div>
                        </div>
                        <div class="deep-think-progress">
                            <div class="deep-think-progress-bar" id="dt-progress" style="width:5%"></div>
                        </div>
                        <div class="deep-think-body" id="dt-body"></div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(panel);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return panel;
        }

        function addAgentEntry(containerId, agent, icon, label, text) {
            const body = document.getElementById(containerId);
            if (!body) return;
            const div = document.createElement("div");
            div.className = `agent-message agent-${agent}`;
            div.innerHTML = `
                <div class="agent-tag agent-tag-${agent}">${icon} ${label}</div>
                <div class="agent-text">${escapeHtml(text)}</div>
            `;
            body.appendChild(div);
            const chat = document.getElementById("chat-container");
            if (chat) chat.scrollTop = chat.scrollHeight;
        }

        function updateDTStatus(text) {
            const el = document.getElementById("dt-status");
            if (el) el.textContent = text;
        }

        function updateDTProgress(pct) {
            const el = document.getElementById("dt-progress");
            if (el) el.style.width = pct + "%";
        }

        async function deepThinkPipeline(chat, userMessage) {
            const model = chat.model;
            state.abortController = new AbortController();
            const signal = state.abortController.signal;

            const dtPanel = createDeepThinkUI();
            const deepThinkLog = [];

            const conversationContext = chat.messages
                .filter(m => m.role !== "system")
                .slice(-6)
                .map(m => `${m.role === "user" ? "User" : "Assistant"}: ${m.content}`)
                .join("\n\n");

            try {
                // ===== STEP 1: Researcher =====
                updateDTStatus("üîç Researcher is analyzing...");
                updateDTProgress(15);

                const researcherPrompt = `You are Agent-R (The Researcher). Your job is to deeply analyze the user's question, break it down, gather your thoughts, consider multiple angles, and produce a thorough DRAFT response. Be detailed and comprehensive. Include any relevant context, examples, edge cases, and nuances. Do NOT hold back ‚Äî give the fullest answer you can as a draft.

Previous conversation for context:
${conversationContext}`;

                const researcherResult = await callAgent(
                    researcherPrompt,
                    [{ role: "user", content: userMessage }],
                    model,
                    signal
                );

                const researcherEntry = { agent: "researcher", icon: "üîç", label: "Agent-R (Researcher)", text: researcherResult };
                deepThinkLog.push(researcherEntry);
                addAgentEntry("dt-body", "researcher", "üîç", "Agent-R (Researcher)", researcherResult);

                await delay(1500);

                // ===== STEP 2: Critic =====
                updateDTStatus("üî¥ Critic is reviewing...");
                updateDTProgress(40);

                const criticPrompt = `You are Agent-C (The Critic/Skeptic). You receive a DRAFT response from Agent-R and your job is to:
1. Identify any factual errors, logical gaps, missing information, or weak arguments
2. Point out where the response could be clearer or more precise  
3. Suggest specific improvements with concrete recommendations
4. Rate the draft quality (Poor / Acceptable / Good / Excellent)
5. If the draft is already Excellent, say so ‚Äî don't nitpick for the sake of it

Be direct and constructive. Your critique will be used to improve the final answer.`;

                const criticResult = await callAgent(
                    criticPrompt,
                    [
                        { role: "user", content: `Original question: "${userMessage}"\n\nAgent-R's Draft:\n${researcherResult}` }
                    ],
                    model,
                    signal
                );

                const criticEntry = { agent: "critic", icon: "üî¥", label: "Agent-C (Critic)", text: criticResult };
                deepThinkLog.push(criticEntry);
                addAgentEntry("dt-body", "critic", "üî¥", "Agent-C (Critic)", criticResult);

                await delay(1500);

                // ===== STEP 3: Researcher Revision (same "instance" ‚Äî reuses researcher role) =====
                updateDTStatus("üîç Researcher revising based on critique...");
                updateDTProgress(65);

                const revisionPrompt = `You are Agent-R (The Researcher) again. You previously wrote a draft, and Agent-C (The Critic) has reviewed it. Now incorporate the feedback to produce an IMPROVED, REVISED draft. Fix any issues raised, fill gaps, and strengthen weak areas. If the critic said it was already excellent, just polish it slightly.`;

                const revisionResult = await callAgent(
                    revisionPrompt,
                    [
                        { role: "user", content: `Original question: "${userMessage}"\n\nYour original draft:\n${researcherResult}\n\nAgent-C's critique:\n${criticResult}\n\nPlease produce your revised draft now.` }
                    ],
                    model,
                    signal
                );

                const revisionEntry = { agent: "researcher", icon: "üîç", label: "Agent-R (Revision)", text: revisionResult };
                deepThinkLog.push(revisionEntry);
                addAgentEntry("dt-body", "researcher", "üîç", "Agent-R (Revision)", revisionResult);

                await delay(1500);

                // ===== STEP 4: Manager ‚Äî Final Polish =====
                updateDTStatus("üü£ Manager polishing final response...");
                updateDTProgress(85);

                const managerPrompt = `You are Agent-M (The Manager). You receive a revised draft that has already been through research and peer review. Your job is to:
1. Take the revised draft and produce the FINAL, polished response
2. Ensure it directly answers the user's question clearly
3. Fix any formatting, tone, or flow issues
4. Remove any meta-commentary about the review process ‚Äî the user should receive a clean, direct answer
5. Keep the depth and quality from the research, but make it feel natural and well-written

Output ONLY the final answer. No preamble about agents or review. Just the best possible response to the user.`;

                const managerResult = await callAgent(
                    managerPrompt,
                    [
                        { role: "user", content: `Original question: "${userMessage}"\n\nRevised draft (post-critique):\n${revisionResult}\n\nProduce the final polished answer now.` }
                    ],
                    model,
                    signal
                );

                const managerEntry = { agent: "manager", icon: "üü£", label: "Agent-M (Manager)", text: "Final response polished and delivered." };
                deepThinkLog.push(managerEntry);
                addAgentEntry("dt-body", "manager", "üü£", "Agent-M (Manager)", "Final response polished and delivered ‚úì");

                updateDTProgress(100);
                updateDTStatus("‚úì Deep Think Complete");

                // Replace spinner with checkmark
                const spinner = dtPanel.querySelector(".deep-think-spinner");
                if (spinner) {
                    spinner.outerHTML = `<span class="deep-think-done-check">‚úì</span>`;
                }

                // Add toggle arrow
                const header = dtPanel.querySelector(".deep-think-header");
                if (header && !header.querySelector(".deep-think-toggle-arrow")) {
                    const arrow = document.createElement("span");
                    arrow.className = "deep-think-toggle-arrow open";
                    arrow.textContent = "‚ñº";
                    header.appendChild(arrow);
                    header.style.cursor = "pointer";
                    header.addEventListener("click", () => {
                        const body = dtPanel.querySelector(".deep-think-body");
                        if (body) body.classList.toggle("collapsed");
                        arrow.classList.toggle("open");
                    });
                }

                // Remove the live panel from DOM - it'll be re-rendered via renderMessages
                dtPanel.remove();

                // Save the final response
                const msg = {
                    role: "assistant",
                    content: managerResult,
                    deepThinkLog: deepThinkLog
                };
                chat.messages.push(msg);
                saveChats();
                renderMessages();

            } catch (error) {
                dtPanel.remove();
                if (error.name !== "AbortError") {
                    chat.messages.push({ role: "assistant", content: `‚ùå Deep Think Error: ${error.message}` });
                    saveChats();
                    renderMessages();
                }
                throw error;
            }
        }

        // ===== Send Message =====
        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || state.isGenerating) return;

            if (!state.apiKey) {
                showToast("‚ö†Ô∏è Set your API key in ‚öôÔ∏è Settings first!");
                settingsModal.classList.add("visible");
                return;
            }

            // Get or create chat
            let chat = getActiveChat();
            if (!chat) {
                chat = createNewChat();
            }

            // Update model
            chat.model = modelSelect.value;

            // Add user message
            chat.messages.push({ role: "user", content: text });
            updateChatTitle(chat);
            saveChats();
            renderChatList();
            renderMessages();

            messageInput.value = "";
            messageInput.style.height = "auto";
            state.isGenerating = true;
            sendBtn.disabled = true;
            statusText.textContent = "Generating...";

            try {
                if (state.deepThink) {
                    // ===== Deep Think Mode =====
                    statusText.textContent = "üß† Deep Thinking...";
                    await deepThinkPipeline(chat, text);
                } else {
                    // ===== Normal Mode =====
                    // Show typing indicator
                    const typingDiv = document.createElement("div");
                    typingDiv.className = "message bot-msg";
                    typingDiv.innerHTML = `
                        <div class="message-wrapper">
                            <span class="message-label bot-label">${modelInfo[chat.model]?.name || chat.model}</span>
                            <div class="typing-indicator">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                        </div>
                    `;
                    chatContainer.appendChild(typingDiv);
                    chatContainer.scrollTop = chatContainer.scrollHeight;

                    const apiMessages = chat.messages.map(m => ({ role: m.role, content: m.content }));

                    if (state.streaming) {
                        await streamResponse(chat, apiMessages, typingDiv);
                    } else {
                        await nonStreamResponse(chat, apiMessages, typingDiv);
                    }
                }
            } catch (error) {
                if (error.name !== "AbortError") {
                    // Error already handled in sub-functions
                }
            }

            state.isGenerating = false;
            sendBtn.disabled = false;
            statusText.textContent = "Ready";
            state.abortController = null;
        }

        // ===== Non-Streaming =====
        async function nonStreamResponse(chat, apiMessages, typingDiv) {
            state.abortController = new AbortController();

            const body = {
                model: chat.model,
                messages: apiMessages,
                stream: false
            };
            if (state.thinking) body.include_thinking = true;

            const response = await fetch(`${state.endpoint}/chat/completions`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${state.apiKey}`
                },
                body: JSON.stringify(body),
                signal: state.abortController.signal
            });

            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(err.error?.message || err.error || `HTTP ${response.status}`);
            }

            const data = await response.json();
            const choice = data.choices[0];
            const msg = {
                role: "assistant",
                content: choice.message.content
            };
            if (choice.message.reasoning_content) {
                msg.reasoning_content = choice.message.reasoning_content;
            }

            typingDiv.remove();
            chat.messages.push(msg);
            saveChats();
            renderMessages();

            if (data.usage) {
                tokenCount.textContent = `${data.usage.total_tokens} tokens`;
            }
        }

        // ===== Streaming =====
        async function streamResponse(chat, apiMessages, typingDiv) {
            state.abortController = new AbortController();

            const body = {
                model: chat.model,
                messages: apiMessages,
                stream: true
            };
            if (state.thinking) body.include_thinking = true;

            const response = await fetch(`${state.endpoint}/chat/completions`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${state.apiKey}`
                },
                body: JSON.stringify(body),
                signal: state.abortController.signal
            });

            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(err.error?.message || err.error || `HTTP ${response.status}`);
            }

            typingDiv.remove();

            const streamDiv = document.createElement("div");
            streamDiv.className = "message bot-msg";
            streamDiv.innerHTML = `
                <div class="message-wrapper">
                    <span class="message-label bot-label">${modelInfo[chat.model]?.name || chat.model}</span>
                    <div class="message-bubble streaming-cursor"></div>
                </div>
            `;
            chatContainer.appendChild(streamDiv);
            const bubble = streamDiv.querySelector(".message-bubble");

            let fullContent = "";
            let reasoningContent = "";

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split("\n");
                buffer = lines.pop() || "";

                for (const line of lines) {
                    const trimmed = line.trim();
                    if (!trimmed || !trimmed.startsWith("data: ")) continue;

                    const data = trimmed.slice(6);
                    if (data === "[DONE]") continue;

                    try {
                        const parsed = JSON.parse(data);
                        const delta = parsed.choices?.[0]?.delta;

                        if (delta?.reasoning_content) {
                            reasoningContent += delta.reasoning_content;
                        }

                        if (delta?.content) {
                            fullContent += delta.content;
                            bubble.innerHTML = formatContent(fullContent);
                            chatContainer.scrollTop = chatContainer.scrollHeight;
                        }
                    } catch (e) {
                        // Skip parse errors
                    }
                }
            }

            bubble.classList.remove("streaming-cursor");
            bubble.innerHTML = formatContent(fullContent);

            const msg = { role: "assistant", content: fullContent };
            if (reasoningContent) msg.reasoning_content = reasoningContent;
            chat.messages.push(msg);
            saveChats();

            if (reasoningContent) renderMessages();
        }

        // ===== Stop Generation =====
        function stopGeneration() {
            if (state.abortController) {
                state.abortController.abort();
                state.isGenerating = false;
                sendBtn.disabled = false;
                statusText.textContent = "Stopped";
                showToast("‚èπ Generation stopped");
            }
        }

        // ===== Event Listeners =====
        sendBtn.addEventListener("click", () => {
            if (state.isGenerating) {
                stopGeneration();
            } else {
                sendMessage();
            }
        });

        messageInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // ===== Init =====
        function init() {
            apiKeyInput.value = state.apiKey;
            systemPromptInput.value = state.systemPrompt;
            endpointInput.value = state.endpoint;

            if (state.chats.length > 0) {
                state.activeChatId = state.chats[0].id;
            }

            renderChatList();
            renderMessages();

            if (!state.apiKey) {
                setTimeout(() => showToast("üëã Set your API key in ‚öôÔ∏è to get started!"), 500);
            }
        }

        init();
    </script>

</body>
</html>
